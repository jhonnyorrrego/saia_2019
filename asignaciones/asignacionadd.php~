<html>
<head>
	<link rel="STYLESHEET" type="text/css" href="css/dhtmlXTree.css">
<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	
	//hide message_body after the first one
	$(".message_list .message_body:gt(-1)").hide();
	$(".message_list .message_body:eq(0)").hide();
	//hide message li after the 5th
	$(".message_list li:gt(1)").hide();
	
	
	//toggle message_body
	$(".message_head").click(function(){
		$(this).next(".message_body").slideToggle(500)
		return false;
	});

	//collapse all messages
	$(".collpase_all_message").click(function(){
		$(".message_body").slideUp(500)
		return false;
	});

	//show all messages
	$(".show_all_message").click(function(){
		$(this).hide()
		$(".show_recent_only").show()
		$(".message_list li:gt(4)").slideDown()
		return false;
	});

	//show recent messages only
	$(".show_recent_only").click(function(){
		$(this).hide()
		$(".show_all_message").show()
		$(".message_list li:gt(4)").slideUp()
		return false;
	});

});
</script>	
<style type="text/css">
* {
	margin: 0;
	padding: 0;
}
body {
	margin: 10px auto;
	width: 570px;
	font: 75%/120% Arial, Helvetica, sans-serif;
}
p {
	padding: 0 0 1em;
}
/* message display page */
.message_list {
	list-style: none;
	margin: 0;
	padding: 0;
	width: 383px;
}
.message_list li {
	padding: 0;
	margin: 0;
	background: url(images/message-bar.gif) no-repeat;
}

.encabezado_lista{
	padding: 0;
	margin: 0;
	background: url(images/message-bar.gif) no-repeat;
	right: 10px;
	top: 15px;
}
.message_head {
	padding: 5px 10px;
	cursor: pointer;
	position: relative;
}
.message_head .timestamp {
	color: #666666;
	font-size: 95%;
	position: absolute;
	right: 10px;
	top: 5px;
}
.message_head cite {
	font-size: 100%;
	font-weight: bold;
	font-style: normal;
}
.message_body {
	padding: 5px 10px 15px;
}
.collapse_buttons {
	text-align: right;
	border-top: solid 1px #e4e4e4;
	padding: 5px 0;
	width: 383px;
}
.collapse_buttons a {
	margin-left: 15px;
	float: right;
}
.show_all_message {
	background: url(images/tall-down-arrow.gif) no-repeat right center;
	padding-right: 12px;
}
.show_recent_only {
	display: none;
	background: url(images/tall-up-arrow.gif) no-repeat right center;
	padding-right: 12px;
}
.collpase_all_message {
	background: url(images/collapse-all.gif) no-repeat right center;
	padding-right: 12px;
	color: #666666;
}
</style>	
<?php
include_once 'funciones.php';
/*
* Obtencion de parametros
*/  
if(isset($_REQUEST['idtarea']))  
  $idtarea=$_REQUEST['idtarea'];
else 
  $idtarea=0;
if(!isset($_REQUEST['iddoc']))
  $iddoc=0;
else 
  $iddoc=$_REQUEST['iddoc'];  
if(!isset($_REQUEST['idserie']))
  $idserie=0;
else 
  $idserie=$_REQUEST['idserie'];
if(!$iddoc && !$idserie){
  alerta("Las tareas deben ser Asignadas a una Serie o Documento");
 // redirecciona("../pendienteslist.php?cmd=resetall");
}  
include_once("../db.php");

?>
<script type="text/javascript" src="../js/dhtmlXCommon.js"></script>
<script type="text/javascript" src="../js/dhtmlXTree.js"></script>
<script language="javascript" type="text/javascript">
<!--
function EW_checkMyForm(EW_this) { 
//Copia las variables oculta para pasar luego al formulario
var list_arbol=tree2.getAllChecked();
var list_asignar=list_arbol.split(",");
EW_this.x_destino.value=list_asignar; 
var list_tareas = tree7.getAllChecked();         
var tareas = list_tareas.split(",");
EW_this.lista_tareas.value=tareas;
if(EW_this.fecha_inicial.value!=""){
  if(EW_this_fecha_final.value==""){
    alert("Por favor Ingrese el Valor de la Fecha Final");
    return(false);
  }  
}
if(EW_this.fecha_final.value!=""){
  if(EW_this_fecha_inicial.value==""){
    alert("Por favor Ingrese el Valor de la Fecha Inicial");
    return(false);
  }  
}

if(EW_this.list_asignar.value=='') {
	this.alert("POR FAVOR INGRESE EL CAMPO REQUERIDO - RESPONSABLE(S) DE LA TAREA");
	 return false;
}

if (EW_this.lista_tareas.value=='') {
	this.alert("POR FAVOR SELECCIONE  EL CAMPO REQUERIDO - TAREAS A ASIGNAR");
	 return false;
}
if (EW_this.iddoc.value=='' && EW_this.idserie.value=='') {
	this.alert("POR FAVOR SELECCIONE  algo para asignar la tarea");
	 return false;
}

return true;
}
-->
</script>
</head>
<?php

function asignaciones($iddoc=NULL,$idserie=NULL,$artareas=NULL,$arentidad=NULL,$fecha_ini=NULL,$fecha_fin=NULL)
{ 
global $conn;
$entrada=0;
$list_entidad = Array();
$list_entidad1 = array(); // Funcionarios Predefinidos para la tarea
$list_dep1 = array();  // Dependencias Predefinidas para la tarea    
$list_entidad2=array();
$list_dep2=array();

foreach($arentidad AS $entidad){ 
  if(!strstr($entidad, '#')){
	  array_push($list_entidad,$entidad);
	}  
	else{	
    array_push($list_dep,str_replace("#","",$entidad));
  }   
}
$res=busca_filtro_tabla("*","entidad","nombre='funcionario'","identidad",$conn);
$identidadf=$res[0]['identidad'];
$res=busca_filtro_tabla("*","entidad","nombre='dependencia'","identidad",$conn);
$identidadd=$res[0]['identidad'];
$ntareas=count($artareas);

if($predefinidos == 1) // se incluiran los responsables Predefinidos 
 { 
   $list_entidad1=busca_filtro_tabla("","entidad_tarea","entidad_identidad=".$identidadf." AND tarea_idtarea IN(".implode(",",$artareas).")","",$conn);
   if($list_entidad1["numcampos"])
   	  {
       $list_entidad2=extrae_campo($list_entidad1,"llave_entidad","U");
	  }
  
   $list_dep1=busca_filtro_tabla("","entidad_tarea","entidad_identidad=".$identidadd." AND tarea_idtarea IN(".implode(",",$artareas).")","",$conn);
   if($list_dep1["numcampos"])
   	  {
	   $list_dep2=extrae_campo($list_dep1,"llave_entidad","U");
	  }
	
$list_entidad3=array_merge((array)$list_entidad,(array)$list_entidad2);
$list_dep3=array_merge((array)$list_dep,(array)$list_dep2);	  
 }
else 
{   
	$list_entidad3=$list_entidad;
	$list_dep3=$list_dep;
} 
 

for($i=0;$i<$ntareas;$i++){
	  $tarea=$artareas[$i];

  	  if(!$fecha_ini || !$fecha_fin)  // no introdujeron rango de fechas toma la fecha actual y el tiempo predefinido de la tarea 
       { 
         $info_tarea= busca_filtro_tabla("*","tarea t","t.idtarea=".$tarea,"",$conn);
         if(!$fecha_ini)
         { 
            $fecha_ini=date("Y-m-d H:i:s"); 
         }  
	   	
	   	if(!$fecha_fin || ($fecha_ini>fecha_fin)) // si la no introdujeron fecha de finalizacion o es invalida 
	   	{
	   		$ar_fechaini=date_parse($fecha_ini);
   			$anioinicial=$ar_fechaini["year"];
   	  		$mesinicial=$ar_fechaini["month"];
   			$diainicial=$ar_fechaini["day"];
   			$horainicial=($ar_fechaini["hour"]!="")? $ar_fechaini["hour"]:0;
   			$minutoinicial=($ar_fechaini["minute"]!="")? $ar_fechaini["minute"]:0;
   			$segundoinicial=($ar_fechaini["second"]!="")? $ar_fechaini["second"]:0;
//            print_r($fecha_ini);   
   	      $fecha_fin=date("Y-m-d H:i:s", mktime( $horainicial+($tarea['tiempo_respuesta']), $minutoinicial, $segundoinicial,$mesinicial, $diainicial,$anioinicial));
   	   }   
   	     
     } 

 	  if(count($list_entidad3))
	    if(asignar_tarea($iddoc,$idserie,$tarea,$list_entidad3,$identidadf,$fecha_ini,$fecha_fin))
	      $entrada=1;//asignacion de tareas a Dependencias
	  if(count($list_dep3))
	    if(asignar_tarea($iddoc,$idserie,$tarea,$list_dep3,$identidadd,$fecha_ini,$fecha_fin))
	      $entrada=1;//asignacion de tareas a Dependencias con Exito
	 }
 
return($entrada);
}

if(isset($_POST['enviar']) && $_POST['enviar']){ // Verifica INICIAR PROCESAMIENTO o despliegue formulario
  //print_r($_REQUEST);
  $tipo_destino=NULL;// Entidad, Func, Cargo etc
  $list_destinos=NULL; 
  $list_tareas=array();
  $list_entidad=array();
  
  if(@$_POST['lista_tareas'])
    $list_tareas=explode(",",$_POST['lista_tareas']); // lista de tareas
     
  if(@$_POST['x_destino'])  
    $list_entidad=explode(",",$_POST['x_destino']); // lista de destinos asiganados a la tarea
    
  if(@$_POST["fecha_inicial"]){
    $fecha_ini=$_POST["fecha_inicial"];
  }  
  else $fecha_ini=NULL;
  if(@$_POST["fecha_final"]){
    $fecha_fin=$_POST["fecha_final"];
  }  
  else $fecha_fin=NULL;
  
  if(asignaciones($iddoc,$idserie,$list_tareas,$list_entidad,$fecha_ini,$fecha_fin)){ //asignacion de tareas
    alerta("Tareas Adicionadas Exitosamente");
  }     
  else alerta("Las Tareas No Fueron Adicionadas");
}
 // Imprime el formulario para ingresar datos !
?>
<script type="text/javascript" src="../popcalendar.js"></script>
<font size="1,5" face="Verdana, Arial, Helvetica, sans-serif">
<!--span ><a href="tarealist.php?cmd=reset">IR AL LISTADO</a></span--> </font>
<form name="asignacionadd" id="asignacionadd" action="asignacionadd.php"  method="post" onSubmit="return EW_checkMyForm(this);">
<input type="hidden" name="x_destino" id="x_destino" value="">
<input type="hidden" name="iddoc" id="iddoc" value="<?php echo @$_REQUEST["iddoc"]; ?>">
<input type="hidden" name="idserie" id="idserie" value="<?php echo @$_REQUEST["idserie"]; ?>">
<input type="hidden" name="lista_tareas" id="lista_tareas" value="">
<table border="0" cellspacing="1" cellpadding="4" bgcolor="FFFFFF" width="100%" align="center">
  <tr><td colspan="2"> 
  <label>Incluir Responables Pre-Definidos En la Tarea &nbsp;&nbsp;&nbsp;</label><input type="checkbox" name="predefinidos" value="1">
    </td><td></td></tr>
  <tr valign="top" width="50%">
	 <td>
    <div class="encabezado_lista"><p>Tareas Predefiidas</p></div>
		<div class="message_body">
  	<div id="treeboxbox_treetareas"></div>
  		<script type="text/javascript">
  	    tree7=new dhtmlXTreeObject("treeboxbox_treetareas","100%","100%",0);
  			tree7.setImagePath("../imgs/");
  			tree7.enableIEImageFix(true);
  			tree7.enableCheckBoxes(1);
  			tree7.enableThreeStateCheckboxes(true);
  			tree7.setXMLAutoLoading("generaxml.php?tipo=3");
  			tree7.loadXML("generaxml.php?tipo=3");					
     </script>     		
    </div>
	 </td>
    <td valign="top" width="50%">
   
    <ol class="message_list">
    	<li>
    		<p class="message_head">Responsables</p>
        <div class="message_body">
        <div id="treeboxbox_treeresp"> </div>
          <script type="text/javascript">
            tree2=new dhtmlXTreeObject("treeboxbox_treeresp","400px","300px",0);
            tree2.setImagePath("../imgs/");
            tree2.enableIEImageFix(true);
            tree2.enableCheckBoxes(1);
            tree2.enableThreeStateCheckboxes(true);
            tree2.setXMLAutoLoading("../test.php");
            tree2.loadXML("../test.php");
          </script>
        </div>  			
    	</li>
    	<li>
    		<p class="message_head">Asignaciones Adicionales</p>
    		<div class="message_body">
      	   <br>Fecha Inicial: <input type="text" name="fecha_inicial" value=""><input type="image" src="../images/ew_calendar.gif" alt="Escoger Fecha" onClick="popUpCalendar(this, this.asignacionadd.fecha_inicial,'yyyy/mm/dd H:i:s');return false;"><br>
   		     <br>Fecha Final  : <input type="text" name="fecha_final" value=""><?php selector_fecha("fecha_final","asignacionadd","Y-m-d H:i:s","'.date('m').'","'.date('Y').'","ceramique.css","../","AD:VALOR"); ?><br>
         </div>
    	</li>    	
    </ol>  
    </td>  
  </tr>
  <tr>
   <td colspan="2" bgcolor="#FFFFFF" align="center"> 
     <input type="submit" name="enviar" id="enviar" value="Continuar">
   </td>    
  </tr>       
</table>
</form>
</html>
