<?php
@set_time_limit(0);
include_once("../../../formatos/librerias/encabezado_pie_pagina.php");
//parametros predeterminados para saia
$marca="";
if(!isset($_REQUEST["URL"])){
    $_REQUEST["URL"]="http://".RUTA_PDF."/formatos/".$_REQUEST["plantilla"]."/mostrar_".$_REQUEST["plantilla"].".php?tipo=5&iddoc=".$_REQUEST["iddoc"]."&output=2";  
    //si tiene varios destinos
    if(isset($_REQUEST["destinos"]) || strtolower($_REQUEST["plantilla"])=="carta")
      {global $conn;
       $destinos=busca_filtro_tabla("destinos","ft_carta","documento_iddocumento=".$_REQUEST["iddoc"],"",$conn);

       $lista=explode(",",$destinos[0]["destinos"]);
       if(count($lista)>1)
         {$_REQUEST["process_mode"]="batch";
         $_REQUEST["toc-location"] = "before";
         $_REQUEST["smartpagebreak"] =1;
         $_REQUEST["convert"] = "Convert File"; 
          for($i=0;$i<count($lista);$i++)
            {$_REQUEST["batch"][$i]=$_REQUEST["URL"]."&destino=".$lista[$i];
            }
         }
        else 
         {
           $_REQUEST["process_mode"]="single";
         }      
      }
//die($_REQUEST["URL"]);
    if(isset($_REQUEST["plantilla"])){
      if(isset($_REQUEST["iddoc"])){
        $borrador=busca_filtro_tabla("pdf,iddocumento,estado,plantilla,".fecha_db_obtener('fecha','Y-m-d')." as fecha,numero ",DB.".documento","iddocumento=".$_REQUEST["iddoc"],"",$conn);
        if($borrador["numcampos"] && isset($borrador[0]["estado"]) && ($borrador[0]["estado"]=='ACTIVO' || $borrador[0]["estado"]=='TRAMITE' || $borrador[0]["estado"]=='BORRADOR')){
          $marca="BORRADOR";
          $borrador[0]["nombre"]=$borrador[0]["iddocumento"]."_BORRADOR_";
          if($borrador[0]["plantilla"]!="")
            $borrador[0]["nombre"].=$borrador[0]["plantilla"]."_";
          $borrador[0]["nombre"].=str_replace("-","_",$borrador[0]["fecha"]);  
          $filename=$borrador[0]["nombre"];
        }
        else if($borrador["numcampos"] && isset($borrador[0]["estado"]) && ($borrador[0]["estado"]=='APROBADO' || $borrador[0]["estado"]=='GESTION' || $borrador[0]["estado"]=='CENTRAL' || $borrador[0]["estado"]=='HISTORICO'))
        {
          $borrador[0]["nombre"]="";
          if($borrador[0]["plantilla"]!="")
            $borrador[0]["nombre"]=$borrador[0]["plantilla"]."_";
          $borrador[0]["nombre"].=$borrador[0]["numero"]."_".str_replace("-","_",$borrador[0]["fecha"]);  
          $filename=$borrador[0]["nombre"];
          $nomarch="../out/".$filename.".pdf";
//die($borrador[0]["pdf"]."-".is_file($nomarch));
          if($borrador[0]["pdf"]<>"" && is_file($nomarch))
              {                
              redirecciona($nomarch);
              die();
              }
          else {$sql="UPDATE ".DB.".documento SET pdf='".$nomarch."' WHERE iddocumento=".$_REQUEST["iddoc"];
            phpmkr_query($sql,$conn);
          }
        }   
      }
////Las referencias deben ir relativas a la plantilla o donde se genere el formarto  
     
    $header=encabezado_pie_pagina($_REQUEST["plantilla"],$_REQUEST["iddoc"]);  
    }         
}
$_REQUEST["output"]="2";
//$_REQUEST["pixels"]="640";
//$_REQUEST["scalepoints"]="1" ;
$_REQUEST["renderimages"]="1" ;
//$_REQUEST["renderlinks"]="0" ;
//$_REQUEST["renderfields"]="0" ;
$_REQUEST["media"]="Letter" ;
$_REQUEST["cssmedia"]="screen" ;
if(isset($header)){
  $_REQUEST["leftmargin"]=$header[0]["margen_izquierda"] ;
  $_REQUEST["rightmargin"]=$header[0]["margen_derecha"];
  $_REQUEST["topmargin"]=$header[0]["margen_superior"] ;
  $_REQUEST["bottommargin"]=$header[0]["margen_inferior"] ;
  $_REQUEST["headerhtml"]=$header[0]["encabezado"];
  $_REQUEST["footerhtml"]=$header[0]["pie_pagina"];
}
$_REQUEST["encoding"]="" ;
$_REQUEST["watermarkhtml"]=$marca;
$_REQUEST["method"]="fpdf" ;
$_REQUEST["pdfversion"]="1.3" ;

$_REQUEST["scalepoints"]="1" ;
$_REQUEST["pslevel"]="3";

function encabezado_pie_pagina($plantilla,$doc){
global $conn;
$header=array();
$header=busca_filtro_tabla("encabezado,pie_pagina,margenes,nombre_tabla,idformato","formato","nombre='".$plantilla."'","",$conn);
$mostrar=busca_filtro_tabla("encabezado",$header[0]['nombre_tabla'],"documento_iddocumento=$doc","",$conn);

if(!$mostrar[0][0])
   {$header[0]["encabezado"]="";
    $header[0]["pie_pagina"]="";
   }
   
if(!$header["numcampos"]){
  $header[0]["encabezado"]="";
  $header[0]["pie_pagina"]="";
  $header[0]["margen_izquierda"]=35;
  $header[0]["margen_inferior"]=30;
  $header[0]["margen_derecha"]=26;
  $header[0]["margen_superior"]=20;
}
else {
  $margenes=explode(",",$header[0]["margenes"]);
  $header[0]["margen_izquierda"]=$margenes[0];
  $header[0]["margen_derecha"]=$margenes[1];
  $header[0]["margen_inferior"]=$margenes[3];
  $header[0]["margen_superior"]=$margenes[2];
  
  if($header[0]["encabezado"]=="" || $header[0]["encabezado"]==Null){
    $header[0]["encabezado"]="";
  }
  if($header[0]["pie_pagina"]=="" || $header[0]["pie_pagina"]==Null){
    $header[0]["pie_pagina"]="";
  }
  if($header[0]["margen_izquierda"]=="" || $header[0]["margen_izquierda"]==Null){
    $header[0]["margen_izquierda"]=35;
  }
  if($header[0]["margen_derecha"]=="" || $header[0]["margen_derecha"]==Null){
    $header[0]["margen_derecha"]=26;
  }
  if($header[0]["margen_inferior"]=="" || $header[0]["margen_inferior"]==Null){
    $header[0]["margen_inferior"]=30;
  }
  if($header[0]["margen_superior"]=="" || $header[0]["margen_superior"]==Null){
    $header[0]["margen_superior"]=20;
  }
}
$header[0]["encabezado"]=crear_encabezado_pie_pagina($header[0]["encabezado"],$doc,$header[0]["idformato"]);
$header[0]["pie_pagina"]=crear_encabezado_pie_pagina($header[0]["pie_pagina"],$doc,$header[0]["idformato"]);
return($header);
}
?>
