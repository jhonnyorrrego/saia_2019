<?php$max_salida=6; // Previene algun posible ciclo infinito limitando a 10 los ../$ruta_db_superior=$ruta="";while($max_salida>0){  if(is_file($ruta."db.php")) {    $ruta_db_superior=$ruta; //Preserva la ruta superior encontrada  }  $ruta.="../";  $max_salida--;}include_once($ruta_db_superior."db.php");include_once($ruta_db_superior."workflow/libreria_paso.php");include_once($ruta_db_superior."formatos/librerias/estilo_formulario.php");include_once($ruta_db_superior."libreria_popup.php"); $arr_terminadas=array();$titulo='';$restrictivo[0]=$ruta_db_superior.'botones/workflow/restrictivo.png'; //Se deben ejecutar todas las acciones en el paso.$alt_restrictivo[1]='Se deben ejecutar todas las acciones en el paso.';$restrictivo[1]=$ruta_db_superior.'botones/workflow/norestrictivo.png'; //El cumplimiento de una de las acciones $alt_restrictivo[0]='Esta accion no es necesario ejecutar la accion para terminar el paso.';$tipo_paso[0]=$ruta_db_superior.'botones/workflow/sistema.png';$alt_tipo_paso[1]='Accion ejecutada por el sistema se termina cuando se ejecuta una accion como transferir, aprobar,confirmar, almacenar etc..';$tipo_paso[1]=$ruta_db_superior.'botones/workflow/manual.png';$alt_tipo_paso[0]='Accion ejecutada de forma manual es decir la actividad no requiere una accion del sistema.';$textot='<table width="95%" border="1px" style="border-collapse:collapse;">';$terminadas["numcampos"]=0;               $pasos_devueltos_flujo=busca_filtro_tabla("","paso_instancia_terminada A,paso_documento B","A.documento_iddocumento = B.documento_iddocumento AND B.diagram_iddiagram_instance=".$_REQUEST["diagrama"]." AND A.estado_actividad=7","",$conn);$listado_devueltos=extrae_campo($pasos_devueltos_flujo,"idpaso_instancia","");$paso_documento=busca_filtro_tabla("idpaso_documento","paso_documento","documento_iddocumento=".$_REQUEST["documento"]." AND paso_idpaso=".$_REQUEST["idpaso"]." AND diagram_iddiagram_instance=".$_REQUEST["diagrama"],"",$conn);//print_r($paso_documento);$radicador_salida=busca_filtro_tabla("B.funcionario_codigo","configuracion A, funcionario B","B.login=A.valor AND A.nombre='radicador_salida'","",$conn);if($_REQUEST["documento"]){  $terminadas=busca_filtro_tabla("B.idpaso_actividad, B.descripcion,".fecha_db_obtener("A.fecha","Y-m-d H:i:s")." AS fecha,tipo_terminacion, B.tipo,B.restrictivo, A.responsable,B.entidad_identidad,B.llave_entidad,idpaso_instancia,A.idpaso_instancia,A.documento_iddocumento","paso_instancia_terminada A,paso_actividad B","A.actividad_idpaso_actividad=B.idpaso_actividad AND B.paso_idpaso=".$_REQUEST["idpaso"]." AND A.documento_iddocumento=".$_REQUEST["documento"],"B.orden",$conn);  $titulo.='<br><a href="'.$ruta_db_superior.'ordenar.php?key='.$_REQUEST["documento"].'&accion=mostrar&mostrar_formato=1" target="centro">Ir al documento</a><br>';  //print_r($terminadas);} $textot.='<tr class="encabezado_list"><td colspan="4">Actividades Terminadas</td></tr> <tr class="encabezado_list"><td>Descripci&oacute;n</td><td>Fecha</td><!--td>Propiedades</td!--><td>Responsable</td><td>Tipo</td></tr>';for($i=0;$i<$terminadas["numcampos"];$i++){    //print_r($responsables);  if($terminadas[$i]["tipo_terminacion"]==2){    $tipo_terminacion=busca_filtro_tabla("","paso_inst_terminacion","instancia_idpaso_instancia=".$terminadas[$i]["idpaso_instancia"],"",$conn);    if($tipo_terminacion["numcampos"]){      $descripcion='<a href="comentarios_paso.php?idpaso='.$tipo_terminacion[0]["documento_idpaso_documento"].'#'.$tipo_terminacion[0]["idpaso_inst_terminacion"].'">'.$terminadas[$i]["descripcion"].'</a>';    }	else{    	$descripcion=$terminadas[$i]["descripcion"];	}  }  else{    $descripcion=$terminadas[$i]["descripcion"];  }  if(in_array($terminadas[$i]["idpaso_instancia"],$listado_devueltos)){    $llave_devolucion=1;  }  else{    $llave_devolucion=0;  }  $responsables=busca_filtro_tabla("nombres,apellidos,funcionario_codigo","funcionario","funcionario_codigo=".$terminadas[$i]["responsable"],"",$conn);  //print_r($responsables);  $asignados2=documento_transferido(@$paso_documento[0]["idpaso_documento"],$responsables[0]["funcionario_codigo"],$radicador_salida[0]["funcionario_codigo"]);  if(!$asignados2["numcampos"]){      $enlace='<!--a href="'.$ruta_db_superior."transferenciaadd.php?idpaso_documento=".$paso_documento[0]["idpaso_documento"]."&key=".$terminadas[$i]["documento_iddocumento"]."&seleccionado=".$responsables[0]["funcionario_codigo"].'"-->'.$responsables[0]["nombres"]." ".$responsables[0]["apellidos"].'<!--/a-->';  }  else{    $enlace=$responsables[0]["nombres"]." ".$responsables[0]["apellidos"];  }    $textot.='<tr><td>'.$descripcion.'</td><td>'.$terminadas[$i]["fecha"].'</td><!--td><img class="tooltip_saia" src="'.$restrictivo[$terminadas[$i]["restrictivo"]].'" alt="'.$alt_restrictivo[$terminadas[$i]["restrictivo"]].'"><img class="tooltip_saia" src="'.$tipo_paso[$terminadas[$i]["tipo"]].'" alt="'.$alt_tipo_paso[$terminadas[$i]["tipo"]].'"></td--><td>'.$enlace.'</td><td>'.mostrar_acciones_actividad($terminadas[$i]["idpaso_actividad"],$terminadas[$i]["idpaso_instancia"],$paso_documento[0]["idpaso_documento"],$llave_devolucion).'</td></tr>';  array_push($arr_terminadas,$terminadas[$i]["idpaso_actividad"]);}$condicion_terminadas='';if($terminadas["numcampos"]){  $arr_terminadas=array_unique($arr_terminadas);   //$arr_terminadas=extrae_campo($terminadas,"idpaso_actividad");   $condicion_terminadas=" AND A.idpaso_actividad NOT IN(".implode(",",$arr_terminadas).")";   }$actividades_paso=busca_filtro_tabla("DISTINCT entidad_identidad, llave_entidad,descripcion,restrictivo,tipo,idpaso_actividad,documento_iddocumento","paso_actividad A,paso_documento B","A.paso_idpaso=B.paso_idpaso AND B.documento_iddocumento=".$_REQUEST["documento"]." AND diagram_iddiagram_instance=".$_REQUEST["diagrama"]." AND A.paso_idpaso=".$_REQUEST["idpaso"].$condicion_terminadas,"",$conn);     if($actividades_paso["numcampos"]==0 && !$_REQUEST["documento"]){  $terminadas["numcampos"]=0;    $actividades_paso=busca_filtro_tabla("A.*,-1 AS documento_iddocumento,-1 AS idpaso_documento,B.nombre_paso","paso_actividad A,paso B","A.paso_idpaso=B.idpaso AND A.paso_idpaso=".$_REQUEST["idpaso"],"",$conn);   $titulo='<br /> <b>(Documento sin asignar)</b> ';  $titulo1='Paso:'.$actividades_paso[0]["nombre_paso"]."<br /><br />";      }if(!$terminadas["numcampos"]){  $textot.='<tr><td colspan="5">Paso Sin Iniciar</td></tr>';}$textot.='</table>'; $texto='<table width="95%" border="1px" style="border-collapse:collapse;"><tr><td colspan="5">Listado de Actividades del Paso'.$titulo.' </td></tr><tr><td colspan="5"><!--a href="adicionar_actividad_paso.php?paso_idpaso='.$_REQUEST["idpaso"].'">Adicionar Actividad al Paso</a--></td></tr><tr class="encabezado_list"><td colspan="5">Actividades Pendientes</td></tr>';     $texto.='<tr class="encabezado_list"><td>Descripci&oacute;n</td><td>Propiedades</td><td>Responsable</td><td>Acciones</td></tr>';//print_r($radicador_salida);for($i=0;$i<$actividades_paso["numcampos"];$i++){  $responsable1=array();  if($actividades_paso[$i]["documento_iddocumento"]>0){    $asignados=listar_funcionarios_existentes($actividades_paso[$i]["entidad_identidad"],$actividades_paso[$i]["llave_entidad"]);    $asignados2=documento_transferido($actividades_paso[$i]["documento_iddocumento"],implode(",", $asignados),$radicador_salida[0]["funcionario_codigo"]);    if($asignados2["numcampos"]){      for($j=0;$j<$asignados2["numcampos"];$j++){        array_push($responsable1,$asignados2[$j]["nombres"]." ".$asignados2[$j]["apellidos"]);      }      $responsables["nombre"]=implode("<br />", $responsable1);      }    else{      $responsables=buscar_entidad_asignada($actividades_paso[$i]["entidad_identidad"],$actividades_paso[$i]["llave_entidad"]);      //http://98.158.184.100/~multipro/saia1.06/transferenciaadd.php?idpaso_documento=1&key=499      $enlace=$ruta_db_superior."transferenciaadd.php?idpaso_documento=".$paso_documento[0]["idpaso_documento"]."&key=".$actividades_paso[$i]["documento_iddocumento"];      if($actividades_paso[$i]["entidad_identidad"]==1){        $cant=count($responsables);        if($cant<1){          $enlace.="&seleccionado=".$actividades_paso[$i]["llave_entidad"];        }      }      $responsables["nombre"]='<a href="'.$enlace.'">'.$responsables["nombre"].'</a>';    }  }  else{        $responsables=buscar_entidad_asignada($actividades_paso[$i]["entidad_identidad"],$actividades_paso[$i]["llave_entidad"]);   }    $texto.='<tr><td>'.$actividades_paso[$i]["descripcion"].'</td><td align="center"><img class="tooltip_saia" src="'.$restrictivo[$actividades_paso[$i]["restrictivo"]].'" title="'.$alt_restrictivo[$actividades_paso[$i]["restrictivo"]].'" alt="'.$alt_restrictivo[$actividades_paso[$i]["restrictivo"]].'"><img class="tooltip_saia" src="'.$tipo_paso[$actividades_paso[$i]["tipo"]].'" title="'.$alt_tipo_paso[$actividades_paso[$i]["tipo"]].'" alt="'.$alt_tipo_paso[$actividades_paso[$i]["tipo"]].'"></td><td>'.$responsables["nombre"].'</td><td>'.ejecutar_acciones_actividad($actividades_paso[$i]["idpaso_actividad"],$actividades_paso[$i]["documento_iddocumento"],$paso_documento[0]["idpaso_documento"],$pasos_devueltos_flujo["numcampos"]).'</td></tr>';}if(!$actividades_paso["numcampos"]){  $texto.='<tr><td colspan="5">Paso Terminado o documento no asignado</td></tr>';}$texto.='</table>';  if(@$_REQUEST["idpaso_documento"]){  menu_pasos(0,@$_REQUEST["idpaso_documento"]);} else   echo($titulo1);echo($texto."<br />".$textot);?>