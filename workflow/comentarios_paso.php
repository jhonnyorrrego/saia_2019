<?php$max_salida=6; // Previene algun posible ciclo infinito limitando a 10 los ../$ruta_db_superior=$ruta="";while($max_salida>0){  if(is_file($ruta."db.php")) {    $ruta_db_superior=$ruta; //Preserva la ruta superior encontrada  }  $ruta.="../";  $max_salida--;}include_once($ruta_db_superior."db.php");include_once($ruta_db_superior."workflow/libreria_paso.php");include_once($ruta_db_superior."formatos/librerias/estilo_formulario.php");menu_pasos(0,$_REQUEST["idpaso"]);$paso_documento=busca_filtro_tabla("","paso_documento","idpaso_documento=".$_REQUEST["idpaso"],"",$conn);$comentarios_documento=busca_filtro_tabla("","comentario_img","documento_iddocumento=".$paso_documento[0]["documento_iddocumento"],"",$conn);//print_r($comentarios_documento);$comentarios_transferencias=busca_filtro_tabla("","buzon_salida","archivo_idarchivo=".$paso_documento[0]["documento_iddocumento"]." AND nombre='TRANSFERIDO' AND (ver_notas=1 OR (ver_notas=0 AND tipo_destino=1 AND destino=".$_SESSION["usuario_actual"].") OR (ver_notas=0 AND tipo_destino=1 AND origen=".$_SESSION["usuario_actual"]."))","",$conn);//print_r($comentarios_transferencias);$comentarios_terminacion=busca_filtro_tabla("A.responsable,A.idpaso_instancia,B.tipo,A.fecha,C.nombres,C.apellidos,A.documento_iddocumento","paso_instancia_terminada A, paso_actividad B,vfuncionario_dc C","A.responsable=C.funcionario_codigo AND A.actividad_idpaso_actividad=B.idpaso_actividad AND B.paso_idpaso=".$paso_documento[0]["paso_idpaso"]." AND A.documento_iddocumento=".$paso_documento[0]["documento_iddocumento"],"GROUP BY A.responsable,A.idpaso_instancia,B.tipo,A.fecha,C.nombres,C.apellidos,A.documento_iddocumento",$conn);//print_r($comentarios_terminacion);$texto_doc='<table width="95%" border="1px" style="border-collapse:collapse;">';$texto_doc.='<tr class="encabezado_list"><td colspan="4">Notas Post-It</td></tr> <tr class="encabezado_list"><td>Descripcion</td><td>Fecha</td><!--td>Propiedades</td!--><td>Responsable</td><td>&nbsp;</td></tr>';$texto_tran='<table width="95%" border="1px" style="border-collapse:collapse;">';$texto_tran.='<tr class="encabezado_list"><td colspan="4">Comentarios Transferencias</td></tr> <tr class="encabezado_list"><td>Descripcion</td><td>Fecha</td><td>Responsable</td><td>&nbsp;</td><td>Docs</td></tr>';$texto_term='<table width="95%" border="1px" style="border-collapse:collapse;">';$texto_term.='<tr class="encabezado_list"><td colspan="5">Rastro de Terminaci&oacute;n de Actividades</td></tr> <tr class="encabezado_list"><td>Fecha</td><td>Descripcion</td><td>Responsable</td><td>Anexos</td><td>Documento</td></tr>'; echo($texto_term); //print_r($comentarios_terminacion);$nombre_estado=array();$nombre_estado[1]='Ejecutado';$nombre_estado[2]='Ejecutado';$nombre_estado[3]='Cancelado';$nombre_estado[4]='Pendiente';$nombre_estado[5]='Atrasado';$nombre_estado[6]='Pendiente';$nombre_estado[7]='Devuelto';for($i=0;$i<$comentarios_terminacion["numcampos"];$i++){  $texto_term='';  $rastro_actividad=busca_filtro_tabla("","paso_instancia_rastro A, vfuncionario_dc B","A.funcionario_codigo=B.funcionario_codigo AND A.instancia_idpaso_instancia=".$comentarios_terminacion[$i]["idpaso_instancia"],"",$conn);  //print_r($rastro_actividad);  $terminacion_manual=busca_filtro_tabla("","paso_inst_terminacion","instancia_idpaso_instancia=".$comentarios_terminacion[$i]["idpaso_instancia"],"",$conn);  //print_r($terminacion_manual);  $observaciones='';  if($terminacion_manual["numcampos"]){    $observaciones=$terminacion_manual[0]["observaciones"];  }  else if($comentarios_terminacion[$i]["tipo"]==1){    $observaciones='Actividad terminada por el sistema';  }  $texto_term.='<tr><td>'.$comentarios_terminacion[$i]["fecha"].'</td><td><a name="paso_ppal'.$comentarios_terminacion[$i]["idpaso_instancia"].'">'.$observaciones.'</a></td><!--td>Propiedades</td!--><td>'.$comentarios_terminacion[$i]["nombres"]." ".$comentarios_terminacion[$i]["apellidos"].'</td><td>'.(listar_anexos($comentarios_terminacion[$i]["documento_iddocumento"])).'</td><td><a href="'.$ruta_db_superior.'ordenar.php?key='.$comentarios_terminacion[$i]["documento_iddocumento"].'&acccion=mostrar&mostrar_formato=1"  target="centro">Detalles</a></td></tr>';  for($j=0;$j<$rastro_actividad["numcampos"];$j++){    $texto_term.='<tr><td>'.$rastro_actividad[$j]["fecha_cambio"].'</td><td>Pasa de estado <b>'.$nombre_estado[$rastro_actividad[$j]["estado_original"]]."</b> a <b>".$nombre_estado[$rastro_actividad[$j]["estado_final"]]."</b> Con Observaciones:<br />".$rastro_actividad[$j]["observaciones"].'</td><td>'.$rastro_actividad[$j]["nombres"]." ".$rastro_actividad[$j]["apellidos"].'</td><td>&nbsp;</td></tr>';  }  echo($texto_term);}echo("</table>");function listar_anexos($iddoc){    global $conn;    $anexos = busca_filtro_tabla("","paso_actividad_anexo","documento_iddocumento=".$iddoc,"",$conn);    if($anexos["numcampos"] > 0){        for($i=0;$i<$anexos["numcampos"];$i++){            $imprimir .= '<a href="'.$anexos[$i]["ruta"].'" target="_blank">'.$anexos[$i]["etiqueta"].'</a><br>';        }    }    else        $imprimir = "No hay anexos";        return $imprimir;}?>