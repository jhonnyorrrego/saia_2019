function Handle(a){this.type=a;this.x=0;this.y=0;this.visible=true}Handle.types=["n","ne","e","se","s","sw","w","nw","r"];Handle.connectorTypes=["ns","ew"];Handle.load=function(b){var a=new Handle(b.type);a.x=b.x;a.y=b.y;a.visible=b.visible;return a};Handle.loadArray=function(a){var c=[];for(var b=0;b<a.length;b++){c.push(Handle.load(a[b]))}return c};Handle.RADIUS=3;Handle.prototype={equals:function(a){if(!a instanceof Handle){return false}return this.type==a.type&&this.x==a.x&&this.y==a.y&&this.visible==a.visible},actionFigure:function(e,c,r){if(this.type!="r"){var k=Util.getAngle(HandleManager.figure.rotationCoords[0],HandleManager.figure.rotationCoords[1]);var b=HandleManager.figure.rotationCoords[0].clone();HandleManager.figure.transform(Matrix.translationMatrix(-b.x,-b.y));HandleManager.figure.transform(Matrix.rotationMatrix(-k));HandleManager.figure.transform(Matrix.translationMatrix(b.x,b.y));var g=new Point(c,r);g.transform(Matrix.translationMatrix(-b.x,-b.y));g.transform(Matrix.rotationMatrix(-k));g.transform(Matrix.translationMatrix(b.x,b.y));c=g.x;r=g.y;var d=new Point(this.x,this.y);d.transform(Matrix.translationMatrix(-b.x,-b.y));d.transform(Matrix.rotationMatrix(-k));d.transform(Matrix.translationMatrix(b.x,b.y))}var i=HandleManager.figure.getBounds();var m=0;var l=0;var q=1;var o=1;var f=false;switch(this.type){case"n":l=i[3];if(r<i[3]-5){o=(i[3]-r)/(i[3]-d.y)}break;case"s":l=i[1];if(r>i[1]+5){o=(r-i[1])/(d.y-i[1])}break;case"w":m=i[2];if(c<i[2]-5){q=(i[2]-c)/(i[2]-d.x)}break;case"e":m=i[0];if(c>i[0]+5){q=(c-i[0])/(d.x-i[0])}break;case"nw":m=i[2];l=i[3];if(c<i[2]-5&&r<i[3]-5){o=(i[3]-r)/(i[3]-d.y);q=(i[2]-c)/(i[2]-d.x)}break;case"ne":m=i[0];l=i[3];if(c>i[0]+5&&r<i[3]-5){q=(c-i[0])/(d.x-i[0]);o=(i[3]-r)/(i[3]-d.y)}break;case"sw":m=i[2];l=i[1];if(c<i[2]-5&&r>i[1]+5){q=(i[2]-c)/((i[2]-d.x));o=(r-i[1])/(d.y-i[1])}break;case"se":m=i[0];l=i[1];if(c>i[0]+5&&r>i[1]+5){o=(r-i[1])/(d.y-i[1]);q=(c-i[0])/(d.x-i[0])}break;case"r":var a=HandleManager.figure.rotationCoords[0].clone();var h=Util.getAngle(HandleManager.figure.rotationCoords[0],new Point(c,r));var n=Util.getAngle(HandleManager.figure.rotationCoords[0],HandleManager.figure.rotationCoords[1]);var j=h-n;HandleManager.figure.transform(Matrix.translationMatrix(-a.x,-a.y));HandleManager.figure.transform(Matrix.rotationMatrix(j));HandleManager.figure.transform(Matrix.translationMatrix(a.x,a.y));break}if(!SHIFT_PRESSED&&m!=0&&l!=0){if(this.getCursor()=="w-resize"||this.getCursor()=="e-resize"){o=q}else{q=o}}if(this.type!="r"){HandleManager.figure.transform(Matrix.translationMatrix(-m,-l));HandleManager.figure.transform(Matrix.scaleMatrix(q,o));HandleManager.figure.transform(Matrix.translationMatrix(m,l));HandleManager.figure.transform(Matrix.translationMatrix(-b.x,-b.y));HandleManager.figure.transform(Matrix.rotationMatrix(k));HandleManager.figure.transform(Matrix.translationMatrix(b.x,b.y))}},actionConnector:function(a,e,d){switch(this.type){case"v":var b;for(var c=1;c<HandleManager.figure.turningPoints.length-1;c++){if(HandleManager.figure.turningPoints[c-1].y==HandleManager.figure.turningPoints[c].y&&HandleManager.figure.turningPoints[c].y==this.y&&Math.min(HandleManager.figure.turningPoints[c].x,HandleManager.figure.turningPoints[c-1].x)<=this.x&&Math.max(HandleManager.figure.turningPoints[c].x,HandleManager.figure.turningPoints[c-1].x)>=this.x){b=c}}HandleManager.figure.turningPoints[b-1].transform(Matrix.translationMatrix(0,d-a[1]));HandleManager.figure.turningPoints[b].transform(Matrix.translationMatrix(0,d-a[1]));break;case"h":var b;for(var c=1;c<HandleManager.figure.turningPoints.length-1;c++){if(HandleManager.figure.turningPoints[c-1].x==HandleManager.figure.turningPoints[c].x&&HandleManager.figure.turningPoints[c].x==this.x&&Math.min(HandleManager.figure.turningPoints[c].y,HandleManager.figure.turningPoints[c-1].y)<=this.y&&Math.max(HandleManager.figure.turningPoints[c].y,HandleManager.figure.turningPoints[c-1].y)>=this.y){b=c}}HandleManager.figure.turningPoints[b-1].transform(Matrix.translationMatrix(e-a[0],0));HandleManager.figure.turningPoints[b].transform(Matrix.translationMatrix(e-a[0],0));break}HandleManager.figure.updateMiddleText()},action:function(a,c,b){if(a==null||a.length!=2){throw new Exception("Handle:action() Last move is wrong")}if(HandleManager.figure instanceof Connector){this.actionConnector(a,c,b)}else{this.actionFigure(a,c,b)}},paint:function(b){b.beginPath();b.arc(this.x,this.y,Handle.RADIUS,0,Math.PI*2,false);b.fillStyle="rgb(0,255,0)";b.closePath();b.fill();b.beginPath();b.arc(this.x,this.y,Handle.RADIUS,0,Math.PI*2,false);b.strokeStyle="rgb(0,0,0)";b.closePath();b.stroke();if(this.type=="r"){var a=new Line(new Point(this.x,this.y),new Point(HandleManager.handles[1].x,HandleManager.handles[1].y));a.style.dashLength=3;a.style.strokeStyle="grey";a.paint(b)}},contains:function(a,c){var b=new Point(this.x,this.y);return b.near(a,c,Handle.RADIUS)},getBounds:function(){return[this.x-Handle.RADIUS,this.y-Handle.RADIUS,this.x+Handle.RADIUS,this.y+Handle.RADIUS]},transform:function(a){var b=new Point(this.x,this.y);b.transform(a);this.x=b.x;this.y=b.y},getCursor:function(){if(HandleManager.figure instanceof Connector){if(this.visible==false){return""}if(this.type=="v"){return"ns-resize"}else{return"ew-resize"}}else{if(this.visible==false){return""}if(this.type=="r"){return"move"}var a=HandleManager.figure.getBounds();var b=new Point(a[0]+((a[2]-a[0])/2),(a[1]+((a[3]-a[1])/2)));var e=-1;var j=2*Math.PI;var g=-1;for(var f=0;f<HandleManager.handles.length-1;f++){var h=new Point(HandleManager.handles[f].x,HandleManager.handles[f].y);var c=Util.getAngle(b,h);if(c<=Math.PI){if(c<j){j=c;e=f}}else{if(2*Math.PI-c<j){j=2*Math.PI-c;e=f}}}for(var d=0;d<8;d++){if(HandleManager.handles[(e+d)%8]==this){return Handle.types[d]+"-resize"}}}return""}};function HandleManager(){}HandleManager.figure=null;HandleManager.handles=[];HandleManager.connectorHandles=[];HandleManager.selectRect=null;HandleManager.handleSelectedIndex=-1;HandleManager.handleGetSelected=function(){if(HandleManager.handleSelectedIndex!=-1){return HandleManager.handles[HandleManager.handleSelectedIndex]}return null};HandleManager.figureSet=function(j){HandleManager.figure=j;HandleManager.handles=[];if(j instanceof Connector){HandleManager.selectRect=null;for(var e=1;e<j.turningPoints.length-2;e++){var f;var k=Util.getAngle(HandleManager.figure.turningPoints[e-1],HandleManager.figure.turningPoints[e],0.00001);var d=Util.getAngle(HandleManager.figure.turningPoints[e],HandleManager.figure.turningPoints[e+1],0.00001);var b=Util.getAngle(HandleManager.figure.turningPoints[e+1],HandleManager.figure.turningPoints[e+2],0.00001);if(k!=d&&d!=b){if(j.turningPoints[e].x==j.turningPoints[e+1].x){f=new Handle("h");f.x=HandleManager.figure.turningPoints[e].x;f.y=(HandleManager.figure.turningPoints[e].y+HandleManager.figure.turningPoints[e+1].y)/2}else{f=new Handle("v");f.x=(HandleManager.figure.turningPoints[e].x+HandleManager.figure.turningPoints[e+1].x)/2;f.y=HandleManager.figure.turningPoints[e].y}f.visible=true;HandleManager.handles.push(f)}}}else{if(j instanceof Figure||j instanceof Group){var c=Util.getAngle(HandleManager.figure.rotationCoords[0],HandleManager.figure.rotationCoords[1]);HandleManager.figure.transform(Matrix.rotationMatrix(-c),false);HandleManager.selectRect=new Polygon();var a=HandleManager.figure.getBounds();HandleManager.selectRect.points=[];HandleManager.selectRect.addPoint(new Point(a[0]-10,a[1]-10));HandleManager.selectRect.addPoint(new Point(a[2]+10,a[1]-10));HandleManager.selectRect.addPoint(new Point(a[2]+10,a[3]+10));HandleManager.selectRect.addPoint(new Point(a[0]-10,a[3]+10));a=HandleManager.selectRect.getBounds();var g=new Handle("nw");g.x=a[0];g.y=a[1];HandleManager.handles.push(g);g=new Handle("n");g.x=a[0]+(a[2]-a[0])/2;g.y=a[1];HandleManager.handles.push(g);g=new Handle("ne");g.x=a[2];g.y=a[1];HandleManager.handles.push(g);g=new Handle("e");g.x=a[2];g.y=a[1]+(a[3]-a[1])/2;HandleManager.handles.push(g);g=new Handle("se");g.x=a[2];g.y=a[3];HandleManager.handles.push(g);g=new Handle("s");g.x=a[0]+(a[2]-a[0])/2;g.y=a[3];HandleManager.handles.push(g);g=new Handle("sw");g.x=a[0];g.y=a[3];HandleManager.handles.push(g);g=new Handle("w");g.x=a[0];g.y=a[1]+(a[3]-a[1])/2;HandleManager.handles.push(g);g=new Handle("r");g.x=a[0]+(a[2]-a[0])/2;g.y=a[1]-20;HandleManager.handles.push(g);HandleManager.selectRect.transform(Matrix.rotationMatrix(c));HandleManager.figure.transform(Matrix.rotationMatrix(c),false);if(j instanceof Figure){if(j.primitives[0] instanceof Text&&j.primitives.length==1){for(var e=0;e<HandleManager.handles.length-1;e++){HandleManager.handles[e].visible=false}}}for(var e=0;e<HandleManager.handles.length;e++){HandleManager.handles[e].transform(Matrix.rotationMatrix(c))}}}};HandleManager.handleGetAll=function(){return HandleManager.handles};HandleManager.handleGet=function(a,c){for(var b=0;b<HandleManager.handles.length;b++){if(HandleManager.handles[b].contains(a,c)){return HandleManager.handles[b]}}return null};HandleManager.handleSelectXY=function(a,c){HandleManager.handleSelectedIndex=-1;for(var b=0;b<HandleManager.handles.length;b++){if(HandleManager.handles[b].contains(a,c)){HandleManager.handleSelectedIndex=b}}};HandleManager.clear=function(){HandleManager.handleSelectedIndex=-1;HandleManager.figure=null;HandleManager.handles=[]};HandleManager.paint=function(c){var b=HandleManager.handleGetAll();c.save();if(HandleManager.selectRect!=null){HandleManager.selectRect.style.strokeStyle="grey";HandleManager.selectRect.paint(c)}for(var a=0;a<b.length;a++){if(b[a].visible==true){b[a].paint(c)}}c.restore()};