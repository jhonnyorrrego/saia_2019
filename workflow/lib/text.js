function Text(c,a,f,b,e,d){this.str=c;this.font=b;this.size=e;this.lineSpacing=1/4*e;this.align=Text.ALIGN_CENTER;this.valign=Text.VALIGN_MIDDLE;this.vector=[new Point(a,f),new Point(a,f-20)];this.style=new Style();if(!d){this.bounds=this.getNormalBounds()}this.debug=false;this.oType="Text"}Text.load=function(b){var a=new Text(b.str,b.x,b.y,b.font,b.size);a.vector=Point.loadArray(b.vector);a.style=Style.load(b.style);return a};Text.ALIGN_LEFT="left";Text.ALIGN_CENTER="center";Text.ALIGN_RIGHT="right";Text.ALIGNMENTS=[{Value:Text.ALIGN_LEFT,Text:"Left"},{Value:Text.ALIGN_CENTER,Text:"Center"},{Value:Text.ALIGN_RIGHT,Text:"Right"}];Text.VALIGN_TOP="top";Text.VALIGN_MIDDLE="middle";Text.VALIGN_BOTTOM="bottom";Text.VALIGNMENTS=[{Value:Text.VALIGN_TOP,Text:"Top"},{Value:Text.VALIGN_MIDDLE,Text:"Middle"},{Value:Text.VALIGN_BOTTOM,Text:"Bottom"}];Text.FONTS=[{Value:"arial",Text:"Arial"},{Value:"arial narrow",Text:"Arial Narrow"},{Value:"courier new",Text:"Courier New"},{Value:"tahoma",Text:"Tahoma"}];Text.SPACE_BETWEEN_CHARACTERS=2;Text.DEFAULT_SIZE=10;Text.prototype={gettextSize:function(){return this.size},settextSize:function(e,a){var b=this.getNormalBounds().getBounds();var c=this.size;this.size=a;var d=this.getNormalBounds().getBounds()},gettext:function(){return this.str},settext:function(d,c){var a=this.getNormalBounds().getBounds();this.str=c;var b=this.getNormalBounds().getBounds()},_getContext:function(){return document.getElementById("a").getContext("2d")},transform:function(a){this.vector[0].transform(a);this.vector[1].transform(a)},getAngle:function(){return Util.getAngle(this.vector[0],this.vector[1])},getNormalWidth:function(){var a=this.str.split("\n");var d=[];var e=0;this._getContext().save();this._getContext().font=this.size+"px "+this.font;for(var b in a){var c=this._getContext().measureText(a[b]);d[b]=c.width}this._getContext().restore();for(b=0;b<d.length;b++){if(e<d[b]){e=d[b]}}return e},getNormalHeight:function(){var a=this.str.split("\n");var c=a.length;var b=0;if(c>0){b=c*this.size+(c-1)*this.lineSpacing}return b},paint:function(b){b.save();var m=this.str.split("\n");var a=0;var h=this.size;var j=this.lineSpacing;var g=h+j;var f=0;if(this.align==Text.ALIGN_LEFT){f=-this.getNormalWidth()/2}else{if(this.align==Text.ALIGN_RIGHT){f=this.getNormalWidth()/2}}var e=0;if(this.valign==Text.VALIGN_TOP){e=-this.getNormalHeight()}else{if(this.valign==Text.VALIGN_BOTTOM){e=this.getNormalHeight()}}var c=Util.getAngle(this.vector[0],this.vector[1]);if(this.debug){b.beginPath();b.moveTo(this.vector[0].x,this.vector[0].y);b.lineTo(this.vector[1].x,this.vector[1].y);b.closePath();b.stroke();var l=this.getNormalBounds();l.transform(Matrix.translationMatrix(-this.vector[0].x,-this.vector[0].y));l.transform(Matrix.rotationMatrix(c));l.transform(Matrix.translationMatrix(this.vector[0].x,this.vector[0].y));l.style.strokeStyle="rgb(250, 34, 35);";l.paint(b);b.save();b.strokeStyle="rgb(30, 204, 35);";var k=l.getBounds();b.beginPath();b.moveTo(k[0],k[1]);b.lineTo(k[2],k[1]);b.lineTo(k[2],k[3]);b.lineTo(k[0],k[3]);b.closePath();b.stroke();b.restore()}b.translate(this.vector[0].x,this.vector[0].y);b.rotate(c);b.translate(-this.vector[0].x,-this.vector[0].y);b.fillStyle=this.style.fillStyle;b.font=this.size+"px "+this.font;b.textAlign=this.align;for(var d=0;d<m.length;d++){b.fillText(m[d],this.vector[0].x+f,(this.vector[0].y-this.getNormalHeight()/2+(d+1)*this.size+d*this.lineSpacing)+e);a=a+1}b.restore()},getBounds:function(){var b=Util.getAngle(this.vector[0],this.vector[1]);var a=this.getNormalBounds();a.transform(Matrix.translationMatrix(-this.vector[0].x,-this.vector[0].y));a.transform(Matrix.rotationMatrix(b));a.transform(Matrix.translationMatrix(this.vector[0].x,this.vector[0].y));return a.getBounds()},getNormalBounds:function(){var a=this.str.split("\n");var b=new Polygon();b.addPoint(new Point(this.vector[0].x-this.getNormalWidth()/2,this.vector[0].y-this.getNormalHeight()/2));b.addPoint(new Point(this.vector[0].x+this.getNormalWidth()/2,this.vector[0].y-this.getNormalHeight()/2));b.addPoint(new Point(this.vector[0].x+this.getNormalWidth()/2,this.vector[0].y+this.getNormalHeight()/2));b.addPoint(new Point(this.vector[0].x-this.getNormalWidth()/2,this.vector[0].y+this.getNormalHeight()/2));return b},getPoints:function(){return[]},contains:function(a,d){var c=Util.getAngle(this.vector[0],this.vector[1]);var b=this.getNormalBounds();b.transform(Matrix.translationMatrix(-this.vector[0].x,-this.vector[0].y));b.transform(Matrix.rotationMatrix(c));b.transform(Matrix.translationMatrix(this.vector[0].x,this.vector[0].y));return b.contains(a,d)},near:function(b,e,a){var d=Util.getAngle(this.vector[0],this.vector[1]);var c=this.getNormalBounds();c.transform(Matrix.translationMatrix(-this.vector[0].x,-this.vector[0].y));c.transform(Matrix.rotationMatrix(d));c.transform(Matrix.translationMatrix(this.vector[0].x,this.vector[0].y));return c.near(b,e,a)},equals:function(a){if(!a instanceof Text){return false}if(this.str!=a.str||this.font!=a.font||this.size!=a.size||this.lineSpacing!=a.lineSpacing||this.size!=a.size){return false}for(var b=0;b<this.vector.length;b++){if(!this.vector[b].equals(a.vector[b])){return false}}if(!this.style.equals(a.style)){return false}return true},clone:function(){throw"Text:clone - not implemented"},toString:function(){return"Text: "+this.str+" x:"+this.vector[0].x+" y:"+this.vector[0].y},escapeString:function(c){var a=new String(c);var d=[];d.push(["<","&lt;"]);for(var b=0;b<d.length;b++){a=a.replace(d[b][0],d[b][1])}return a},toSVG:function(){var g=this.getAngle()*180/Math.PI;var c=this.getNormalHeight();var b=0;var h="middle";if(this.align==Text.ALIGN_LEFT){b=-this.getNormalWidth()/2;h="start"}else{if(this.align==Text.ALIGN_RIGHT){b=this.getNormalWidth()/2;h="end"}}var a='<text y="'+(this.vector[0].y-c/2)+'" ';a+=' transform="rotate('+g+" "+this.vector[0].x+" ,"+this.vector[0].y+')" ';a+=' font-family="'+this.font+'" ';a+=' font-size="'+this.size+'" ';if(this.style.fillStyle!=null){a+=' fill=" '+this.style.fillStyle+'" '}a+=' text-anchor="'+h+'" ';a+=">";var e=this.str.split("\n");for(var f=0;f<e.length;f++){var d=parseFloat(this.size);if(f>0){d+=parseFloat(this.lineSpacing)}a+='<tspan x="'+(this.vector[0].x+b)+'" dy="'+d+'">'+this.escapeString(e[f])+"</tspan>"}a+="</text>";if(this.debug){a+='<circle cx="'+this.vector[0].x+'" cy="'+this.vector[0].y+'" r="3" style="stroke: #FF0000; fill: yellow;"  transform="rotate('+g+" "+this.vector[0].x+" ,"+this.vector[0].y+')" />';a+='<circle cx="'+this.vector[0].x+'" cy="'+(this.vector[0].y-c/2)+'" r="3" style="stroke: #FF0000; fill: green;"  transform="rotate('+g+" "+this.vector[0].x+" ,"+this.vector[0].y+')"  />'}return a}};